<!doctype html>
<!--
* Tabler - Premium and Open Source dashboard template with responsive and high quality UI.
* @version 1.3.0
* @link https://tabler.io
* Copyright 2018-2025 The Tabler Authors
* Copyright 2018-2025 codecalm.net PaweÅ‚ Kuna
* Licensed under MIT (https://github.com/tabler/tabler/blob/master/LICENSE)
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Zendesk Dashboard - Voice & Tickets</title>
    <!-- BEGIN PAGE LEVEL STYLES -->
    <!-- END PAGE LEVEL STYLES -->
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="./original/dist/css/tabler.css?1747674014" rel="stylesheet" />
    <!-- END GLOBAL MANDATORY STYLES -->
    <!-- BEGIN PLUGINS STYLES -->
    <link href="./original/dist/css/tabler-flags.css?1747674014" rel="stylesheet" />
    <link href="./original/dist/css/tabler-socials.css?1747674014" rel="stylesheet" />
    <link href="./original/dist/css/tabler-payments.css?1747674014" rel="stylesheet" />
    <link href="./original/dist/css/tabler-vendors.css?1747674014" rel="stylesheet" />
    <link href="./original/dist/css/tabler-marketing.css?1747674014" rel="stylesheet" />
    <link href="./original/dist/css/tabler-themes.css?1747674014" rel="stylesheet" />
    <!-- END PLUGINS STYLES -->
    <!-- BEGIN DEMO STYLES -->
    <link href="./original/preview/css/demo.css?1747674014" rel="stylesheet" />
    <!-- END DEMO STYLES -->
    <!-- BEGIN CUSTOM FONT -->
    <style>
      @import url("https://rsms.me/inter/inter.css");
    </style>
    <!-- END CUSTOM FONT -->
  </head>
  <body>
    <!-- BEGIN GLOBAL THEME SCRIPT -->
    <script src="./original/dist/js/tabler-theme.min.js?1747674014"></script>
    <!-- END GLOBAL THEME SCRIPT -->
    <div class="page">
      <!-- BEGIN NAVBAR  -->
      <header class="navbar navbar-expand-md d-print-none">
        <div class="container-xl">
          <!-- BEGIN NAVBAR TOGGLER -->
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbar-menu"
            aria-controls="navbar-menu"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <!-- END NAVBAR TOGGLER -->
          <!-- BEGIN NAVBAR LOGO -->
          <div class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
            <a href="." aria-label="Zendesk Dashboard">
              <h2 class="m-0">Zendesk Dashboard</h2>
            </a>
          </div>
          <!-- END NAVBAR LOGO -->
          <div class="navbar-nav flex-row order-md-last">
            <div class="d-none d-md-flex">
              <div class="nav-item">
                <a href="?theme=dark" class="nav-link px-0 hide-theme-dark" title="Enable dark mode" data-bs-toggle="tooltip" data-bs-placement="bottom">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/moon -->
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="icon icon-1"
                  >
                    <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
                  </svg>
                </a>
                <a href="?theme=light" class="nav-link px-0 hide-theme-light" title="Enable light mode" data-bs-toggle="tooltip" data-bs-placement="bottom">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/sun -->
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="icon icon-1"
                  >
                    <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" />
                    <path d="M3 12h1m8 -9v1m8 8h1m-9 8v1m-6.4 -15.4l.7 .7m12.1 -.7l-.7 .7m0 11.4l.7 .7m-12.1 -.7l-.7 .7" />
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- END NAVBAR  -->
      <div class="page-wrapper">
        <!-- BEGIN PAGE HEADER -->
        <div class="page-header d-print-none" aria-label="Page header">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <h2 class="page-title">Executive Dashboard</h2>
                <div class="text-secondary mt-1">Voice Calls & Ticket Status Trends</div>
              </div>
            </div>
          </div>
        </div>
        <!-- END PAGE HEADER -->
        <!-- BEGIN PAGE BODY -->
        <div class="page-body">
          <div class="container-xl">
            <div class="row row-cards">
              <!-- 30-Day Call Analytics Section -->
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-phone" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2"/>
                      </svg>
                      Call Analytics - Last 30 Days
                    </h3>
                    <div class="card-actions">
                      <button class="btn btn-outline-primary btn-sm" id="refresh-call-analytics">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                          <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
                          <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
                        </svg>
                        Refresh
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- Call Analytics Summary Cards -->
                    <div class="row mb-4" id="call-summary-cards">
                      <div class="col-sm-6 col-lg-2">
                        <div class="card card-sm">
                          <div class="card-body">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="bg-blue text-white avatar">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2"/>
                                  </svg>
                                </span>
                              </div>
                              <div class="col">
                                <div class="font-weight-medium" id="total-calls-30day">
                                  Loading...
                                </div>
                                <div class="text-secondary">
                                  Total Calls
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-6 col-lg-2">
                        <div class="card card-sm">
                          <div class="card-body">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="bg-green text-white avatar">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M5 12l5 5l10 -10"/>
                                  </svg>
                                </span>
                              </div>
                              <div class="col">
                                <div class="font-weight-medium" id="answered-calls-30day">
                                  Loading...
                                </div>
                                <div class="text-secondary">
                                  Answered
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-6 col-lg-2">
                        <div class="card card-sm">
                          <div class="card-body">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="bg-red text-white avatar">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M18 6l-12 12"/>
                                    <path d="M6 6l12 12"/>
                                  </svg>
                                </span>
                              </div>
                              <div class="col">
                                <div class="font-weight-medium" id="abandoned-calls-30day">
                                  Loading...
                                </div>
                                <div class="text-secondary">
                                  Abandoned
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-6 col-lg-2">
                        <div class="card card-sm">
                          <div class="card-body">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="bg-orange text-white avatar">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"/>
                                    <path d="M3 7l9 6l9 -6"/>
                                  </svg>
                                </span>
                              </div>
                              <div class="col">
                                <div class="font-weight-medium" id="callbacks-30day">
                                  Loading...
                                </div>
                                <div class="text-secondary">
                                  Callbacks
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-6 col-lg-2">
                        <div class="card card-sm">
                          <div class="card-body">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="bg-purple text-white avatar">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M3 20l1.3 -3.9a9 8 0 1 1 3.4 2.9l-4.7 1"/>
                                  </svg>
                                </span>
                              </div>
                              <div class="col">
                                <div class="font-weight-medium" id="voicemails-30day">
                                  Loading...
                                </div>
                                <div class="text-secondary">
                                  Voicemails
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-sm-6 col-lg-2">
                        <div class="card card-sm">
                          <div class="card-body">
                            <div class="row align-items-center">
                              <div class="col-auto">
                                <span class="bg-teal text-white avatar">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M7 10l5 -6l5 6"/>
                                    <path d="M21 10l-2 8a2 2.1 0 0 1 -2 2h-10a2 2.1 0 0 1 -2 -2l-2 -8z"/>
                                    <path d="M12 15m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/>
                                  </svg>
                                </span>
                              </div>
                              <div class="col">
                                <div class="font-weight-medium" id="answer-rate-30day">
                                  Loading...
                                </div>
                                <div class="text-secondary">
                                  Answer Rate
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Call Analytics Chart -->
                    <div id="chart-call-analytics-30day" class="position-relative" style="height: 400px;"></div>
                    
                    <!-- Call Analytics Table -->
                    <div class="mt-4">
                      <div class="table-responsive">
                        <table class="table table-vcenter">
                          <thead>
                            <tr>
                              <th>Date</th>
                              <th>Day</th>
                              <th>Total</th>
                              <th>Answered</th>
                              <th>Abandoned</th>
                              <th>Callbacks</th>
                              <th>Voicemails</th>
                              <th>Answer Rate</th>
                            </tr>
                          </thead>
                          <tbody id="call-analytics-table">
                            <tr>
                              <td colspan="8" class="text-center text-secondary">Loading call analytics...</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- END PAGE BODY -->
        <!--  BEGIN FOOTER  -->
        <footer class="footer footer-transparent d-print-none">
          <div class="container-xl">
            <div class="row text-center align-items-center flex-row-reverse">
              <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                <ul class="list-inline list-inline-dots mb-0">
                  <li class="list-inline-item">
                    &copy; 2025 Zendesk Dashboard
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </footer>
        <!--  END FOOTER  -->
      </div>
    </div>
    <!-- BEGIN PAGE LIBRARIES -->
    <script src="./original/dist/libs/apexcharts/dist/apexcharts.min.js?1747674014" defer></script>
    <!-- END PAGE LIBRARIES -->
    <!-- BEGIN GLOBAL MANDATORY SCRIPTS -->
    <script src="./original/dist/js/tabler.min.js?1747674014" defer></script>
    <!-- END GLOBAL MANDATORY SCRIPTS -->
    <!-- BEGIN DEMO SCRIPTS -->
    <script src="./original/preview/js/demo.min.js?1747674014" defer></script>
    <!-- END DEMO SCRIPTS -->
    <!-- BEGIN PAGE SCRIPTS -->
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Load data from execView.json
          const response = await fetch('../data/execView.json');
          const data = await response.json();
          
          // Helper function to filter last N weekdays
          function getLastNWeekdays(dataArray, n) {
            // Filter only weekdays (comment out to show all days including weekends)
            const weekdayData = dataArray.filter(item => {
              const date = new Date(item.date);
              const dayOfWeek = date.getDay();
              return dayOfWeek >= 1 && dayOfWeek <= 5; // Monday-Friday
            });
            
            // Return last N entries from weekdays
            // For now, if weekday data is empty, return all data
            if (weekdayData.length === 0) {
              return dataArray.slice(-n);
            }
            return weekdayData.slice(-n);
          }
          
          // Extract trend data and filter to last 10 weekdays
          const allTotalInboundData = data.trends.voice.totalInboundCalls;
          const allNotAnsweredData = data.trends.voice.notAnsweredCalls;
          
          const totalInboundData = getLastNWeekdays(allTotalInboundData, 10);
          const notAnsweredData = getLastNWeekdays(allNotAnsweredData, 10);
          
          // Prepare categories (dates)
          const categories = totalInboundData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          });
          
          // Calculate answered calls (total - not answered) and not answered calls
          const answeredCalls = totalInboundData.map((item, index) => {
            const total = item.value;
            const notAnswered = notAnsweredData[index].value;
            return total - notAnswered;
          });
          
          const notAnsweredCalls = notAnsweredData.map(item => item.value);
          
          // Create the stacked bar chart
          window.ApexCharts &&
            new ApexCharts(document.getElementById("chart-inbound-calls"), {
              chart: {
                type: "bar",
                fontFamily: "inherit",
                height: 480,
                parentHeightOffset: 0,
                toolbar: {
                  show: false,
                },
                animations: {
                  enabled: true,
                },
                stacked: true,
              },
              plotOptions: {
                bar: {
                  columnWidth: "50%",
                },
              },
              dataLabels: {
                enabled: true,
                style: {
                  fontSize: '12px',
                  fontWeight: 'bold',
                  colors: ['#fff']
                },
              },
              series: [
                {
                  name: "Answered Calls",
                  data: answeredCalls,
                },
                {
                  name: "Not Answered Calls",
                  data: notAnsweredCalls,
                },
              ],
              tooltip: {
                theme: "dark",
                y: {
                  formatter: function(value) {
                    return value + " calls";
                  }
                }
              },
              grid: {
                padding: {
                  top: -20,
                  right: 0,
                  left: -4,
                  bottom: -4,
                },
                strokeDashArray: 4,
              },
              xaxis: {
                labels: {
                  padding: 0,
                  style: {
                    fontSize: '14px',
                  },
                },
                tooltip: {
                  enabled: false,
                },
                axisBorder: {
                  show: false,
                },
                categories: categories,
              },
              yaxis: {
                labels: {
                  padding: 4,
                  style: {
                    fontSize: '14px',
                  },
                },
                title: {
                  text: 'Number of Calls',
                  style: {
                    fontSize: '14px',
                    fontWeight: 600,
                  },
                },
              },
              colors: ["#2fb344", "#d63939"],
              legend: {
                show: true,
                position: "top",
                horizontalAlign: "right",
                offsetY: 0,
                markers: {
                  width: 10,
                  height: 10,
                  radius: 100,
                },
                itemMargin: {
                  horizontal: 8,
                  vertical: 8,
                },
              },
            }).render();
            
          // Create ticket overview mixed chart
          const allTicketData = data.trends.tickets.byStatus;
          
          if (allTicketData && allTicketData.length > 0) {
            // Filter to last 10 weekdays
            const ticketData = getLastNWeekdays(allTicketData, 10);
            
            // Sort by date (oldest first for charts)
            const sortedTicketData = [...ticketData].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Prepare data for ticket chart
            const ticketCategories = sortedTicketData.map(day => {
              const date = new Date(day.date);
              return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            });
            
            // Calculate total active tickets (new + open + pending + solved)
            const totalActiveTickets = sortedTicketData.map(day => 
              day.new + day.open + day.pending + day.solved
            );
            
            // New and Closed for bar chart
            const newTickets = sortedTicketData.map(day => day.new);
            const closedTickets = sortedTicketData.map(day => day.closed);
            
            // Create mixed chart for tickets
            window.ApexCharts &&
              new ApexCharts(document.getElementById("chart-ticket-overview"), {
                chart: {
                  type: "line",
                  fontFamily: "inherit",
                  height: 400,
                  parentHeightOffset: 0,
                  toolbar: {
                    show: false,
                  },
                  animations: {
                    enabled: true,
                  },
                },
                stroke: {
                  width: [3, 0, 0],
                  curve: 'smooth',
                  dashArray: [0, 0, 0]
                },
                plotOptions: {
                  bar: {
                    columnWidth: "50%",
                  },
                },
                dataLabels: {
                  enabled: false,
                },
                series: [
                  {
                    name: "Total Active Tickets",
                    type: "line",
                    data: totalActiveTickets,
                  },
                  {
                    name: "New Tickets",
                    type: "bar",
                    data: newTickets,
                  },
                  {
                    name: "Closed Tickets",
                    type: "bar",
                    data: closedTickets,
                  },
                ],
                tooltip: {
                  theme: "dark",
                  shared: true,
                  intersect: false,
                  y: {
                    formatter: function(value) {
                      return value + " tickets";
                    }
                  }
                },
                grid: {
                  padding: {
                    top: -20,
                    right: 0,
                    left: -4,
                    bottom: -4,
                  },
                  strokeDashArray: 4,
                },
                xaxis: {
                  labels: {
                    padding: 0,
                    style: {
                      fontSize: '12px',
                    },
                  },
                  tooltip: {
                    enabled: false,
                  },
                  axisBorder: {
                    show: false,
                  },
                  categories: ticketCategories,
                },
                yaxis: {
                  labels: {
                    padding: 4,
                    style: {
                      fontSize: '12px',
                    },
                  },
                  title: {
                    text: 'Number of Tickets',
                    style: {
                      fontSize: '13px',
                      fontWeight: 500,
                    },
                  },
                },
                colors: ["#206bc4", "#d63939", "#2fb344"],
                legend: {
                  show: true,
                  position: "top",
                  horizontalAlign: "left",
                  offsetY: 0,
                  markers: {
                    width: 10,
                    height: 10,
                    radius: 100,
                  },
                  itemMargin: {
                    horizontal: 12,
                    vertical: 8,
                  },
                },
              }).render();
            
            // Populate ticket status table
            const tableBody = document.getElementById('ticket-table-body');
            
            // Sort by date (newest first for table)
            const tableSortedData = [...ticketData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableSortedData.forEach(day => {
              const date = new Date(day.date);
              const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
              });
              
              const total = day.new + day.open + day.pending + day.hold + day.solved + day.closed;
              
              const row = document.createElement('tr');
              row.innerHTML = `
                <td><strong>${formattedDate}</strong></td>
                <td class="text-end">${day.new.toLocaleString()}</td>
                <td class="text-end">${day.open.toLocaleString()}</td>
                <td class="text-end">${day.pending.toLocaleString()}</td>
                <td class="text-end">${day.hold.toLocaleString()}</td>
                <td class="text-end">${day.solved.toLocaleString()}</td>
                <td class="text-end">${day.closed.toLocaleString()}</td>
                <td class="text-end"><strong>${total.toLocaleString()}</strong></td>
              `;
              
              tableBody.appendChild(row);
            });
          }
          
        } catch (error) {
          console.error('Error loading chart data:', error);
          document.getElementById("chart-inbound-calls").innerHTML = 
            '<div class="alert alert-danger">Error loading chart data. Please ensure execView.json exists in the data folder.</div>';
        }
      });

      // Call Analytics Functions
      let callAnalyticsChart = null;

      async function loadCallAnalytics() {
        try {
          console.log('Loading call analytics...');
          
          // Show loading state
          document.getElementById('total-calls-30day').textContent = 'Loading...';
          document.getElementById('answered-calls-30day').textContent = 'Loading...';
          document.getElementById('abandoned-calls-30day').textContent = 'Loading...';
          document.getElementById('callbacks-30day').textContent = 'Loading...';
          document.getElementById('voicemails-30day').textContent = 'Loading...';
          document.getElementById('answer-rate-30day').textContent = 'Loading...';
          
          const tableBody = document.getElementById('call-analytics-table');
          tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary">Loading call analytics...</td></tr>';
          
          // Fetch call analytics data
          const response = await fetch('http://localhost:3000/api/call-analytics/30-day');
          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.error || 'Failed to load call analytics');
          }
          
          const data = result.data;
          
          // Update summary cards
          document.getElementById('total-calls-30day').textContent = data.summary.total_calls.toLocaleString();
          document.getElementById('answered-calls-30day').textContent = data.summary.answered_calls.toLocaleString();
          document.getElementById('abandoned-calls-30day').textContent = data.summary.unanswered_calls.toLocaleString();
          document.getElementById('callbacks-30day').textContent = (data.summary.callbacks || 0).toLocaleString();
          document.getElementById('voicemails-30day').textContent = (data.summary.voicemails || 0).toLocaleString();
          document.getElementById('answer-rate-30day').textContent = data.summary.overall_answer_rate + '%';
          
          // Update table
          updateCallAnalyticsTable(data.daily_breakdown);
          
          // Update chart
          updateCallAnalyticsChart(data.chart_data);
          
          console.log('Call analytics loaded successfully');
          
        } catch (error) {
          console.error('Error loading call analytics:', error);
          
          // Show error state
          document.getElementById('total-calls-30day').textContent = 'Error';
          document.getElementById('answered-calls-30day').textContent = 'Error';
          document.getElementById('abandoned-calls-30day').textContent = 'Error';
          document.getElementById('callbacks-30day').textContent = 'Error';
          document.getElementById('voicemails-30day').textContent = 'Error';
          document.getElementById('answer-rate-30day').textContent = 'Error';
          
          const tableBody = document.getElementById('call-analytics-table');
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
          
          // Show error in chart
          document.getElementById('chart-call-analytics-30day').innerHTML = 
            `<div class="alert alert-danger">Error loading call analytics: ${error.message}</div>`;
        }
      }

      function updateCallAnalyticsTable(dailyData) {
        const tableBody = document.getElementById('call-analytics-table');
        tableBody.innerHTML = '';
        
        // Reverse the array so today appears first (newest to oldest)
        const reversedData = [...dailyData].reverse();
        
        reversedData.forEach(day => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${day.date}</strong></td>
            <td><span class="badge bg-blue-lt">${day.day_name}</span></td>
            <td class="text-end">${day.total_calls.toLocaleString()}</td>
            <td class="text-end text-green">${day.answered_calls.toLocaleString()}</td>
            <td class="text-end text-red">${day.unanswered_calls.toLocaleString()}</td>
            <td class="text-end text-orange">${(day.callbacks || 0).toLocaleString()}</td>
            <td class="text-end text-purple">${(day.voicemails || 0).toLocaleString()}</td>
            <td class="text-end">
              <span class="badge ${day.answer_rate >= 80 ? 'bg-green' : day.answer_rate >= 60 ? 'bg-yellow' : 'bg-red'}-lt">
                ${day.answer_rate}%
              </span>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      function updateCallAnalyticsChart(chartData) {
        // Destroy existing chart if it exists
        if (callAnalyticsChart) {
          callAnalyticsChart.destroy();
        }
        
        const chartElement = document.getElementById('chart-call-analytics-30day');
        
        callAnalyticsChart = new ApexCharts(chartElement, {
          chart: {
            type: 'bar',
            height: 400,
            stacked: true,
            toolbar: {
              show: true,
              tools: {
                download: true,
                selection: false,
                zoom: false,
                zoomin: false,
                zoomout: false,
                pan: false,
                reset: false
              }
            },
            animations: {
              enabled: true,
              easing: 'easeinout',
              speed: 800
            }
          },
          series: [
            {
              name: 'Answered Calls',
              data: chartData.series.find(s => s.name === 'Answered Calls')?.data || []
            },
            {
              name: 'Abandoned in Queue',
              data: chartData.series.find(s => s.name === 'Abandoned in Queue')?.data || []
            },
            {
              name: 'Callback Requests',
              data: chartData.series.find(s => s.name === 'Callback Requests')?.data || []
            },
            {
              name: 'Voicemails',
              data: chartData.series.find(s => s.name === 'Voicemails')?.data || []
            },
            {
              name: 'Exceeded Wait Time',
              data: chartData.series.find(s => s.name === 'Exceeded Wait Time')?.data || []
            },
            {
              name: 'Outbound Calls',
              data: chartData.series.find(s => s.name === 'Outbound Calls')?.data || []
            }
          ],
          xaxis: {
            categories: chartData.categories,
            title: {
              text: 'Days'
            },
            labels: {
              style: {
                fontSize: '12px'
              }
            }
          },
          yaxis: {
            title: {
              text: 'Number of Calls'
            },
            labels: {
              style: {
                fontSize: '12px'
              }
            }
          },
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: '55%',
              endingShape: 'rounded'
            }
          },
          dataLabels: {
            enabled: false
          },
          stroke: {
            show: true,
            width: 2,
            colors: ['transparent']
          },
          colors: ['#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#ffc107', '#20c997'], // Green, Red, Orange, Purple, Yellow, Teal
          fill: {
            opacity: 0.8
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return val + " calls"
              }
            }
          },
          legend: {
            position: 'top',
            horizontalAlign: 'left',
            offsetY: 0
          },
          grid: {
            borderColor: '#e7e7e7',
            row: {
              colors: ['#f3f3f3', 'transparent'],
              opacity: 0.5
            }
          }
        });
        
        callAnalyticsChart.render();
      }

      // Load call analytics on page load
      loadCallAnalytics();

      // Add refresh button functionality
      document.getElementById('refresh-call-analytics').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Refreshing...';
        
        loadCallAnalytics().finally(() => {
          this.disabled = false;
          this.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"/>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
            </svg>
            Refresh
          `;
        });
      });

      // Auto-refresh every 5 minutes
      setInterval(loadCallAnalytics, 5 * 60 * 1000);
    </script>
    <!-- END PAGE SCRIPTS -->
  </body>
</html>
